#!/bin/bash

# Hardcoded defaults
#	Immutable
main_directory="$HOME/.playlister/"
config_file="${main_directory}playlister.conf"
config_file_bak="${config_file}.bak"
database="${main_directory}playlister.db"
database_bak="${database}.bak"
helpfile="${main_directory}playlister.help"
#	Mutable
playlist_directory="${main_directory}playlists/"
mp3_directory="/mp3s"
mp3_ext=".mp3"
playlist_ext=".plst"

function main () {
	if [[ "$#" -eq 0 ]]; then
		user-output "invalid argument count (must be > 0)!"
		exit 1
	fi
	while [[ "$#" -gt 0 ]]; do
		case $1 in 
			config)
				shift
				config "$@"
				exit 1
				;;
			*)
				user-output "unrecognised option!"
				shift
				exit 1
				;;
		esac
	done
}

function user-output () {
	local output="$1"
	>&2 echo "$0: $1"
}

function config () {
	if [[ "$#" -eq 0 ]]; then
		user-output "invalid config argument count (must be >0)!"
		exit 1
	fi
	while [[ "$#" -gt 0 ]]; do
		case $1 in
			configure)
				config-configure
				exit 1
				;;
			*)
				user-output "unrecognised config option!"
				exit 1
		esac
	done
}
function config-configure () {
	if ! create-directory "$main_directory" ; then
		exit 1
	fi
	
	if ! setup-file "$helpfile" "currentdir"; then
		user-output "failed to set up $helpfile !"
		exit 1
	fi
	
	# if ! [[ -a "$helpfile" ]]; then
		# user-output "$helpfile not found!"
		# local helpfilename="$(basename $helpfile)"
		# if ! [[ -a "./$helpfilename" ]] ; then
			# user-output "$helpfilename not found in current directory!"
			# exit 1
		# fi
		# user-output "$helpfilename found in current directory."
		# mv $helpfilename $helpfile
		# if ! [[ $? -eq 0 ]]; then
			# user-output "$helpfilename failed to move to $helpfile !"
			# exit 1
		# fi
		# user-output "$helpfilename moved to $helpfile ."
	# else
		# user-output "$helpfile exists."
	# fi
	
}

function create-directory () {
	local directory="$1"
	if [[ -d "$directory" ]]; then
		user-output "$directory already there."
	else
		mkdir $directory
		if [[ $? -ne 0 ]]; then
			user-output "failed to make $directory !"
			return 1
		else
			user-output "made $directory ."
		fi
		
	fi
	return 0
}

function setup-file () {
	local filepath="$1"
	local currentdir="no"
	shift
	while [[ "$#" -ne 0 ]]; do
		case $1 in 
			"currentdir")
				currentdir="yes"
				shift
				;;
			*)
				user-output "unrecognised option!"
				return 1
				;;
		esac
	done
	if [[ -a "$filepath" ]]; then
		user-output "$filepath exists."
		return 0
	fi
	user-output "$filepath does not exist!"

	if [[ "$currentdir" == "yes" ]]; then
		local file="$(basename "$filepath")"
		if ! [[ -a  "$file" ]]; then
			user-output "$file not in current directory!"
		else
			user-output "$file in current directory."
			mv "$file" "$filepath"
			if [[ $? -eq 0 ]]; then
				user-output "$file moved to $filepath ."
				return 0
			else
				user-output "$file failed to move to $filepath !"
			fi
		fi
	fi
	
	return 1
}

main "$@"
