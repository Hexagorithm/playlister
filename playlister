#!/bin/bash

# Hardcoded defaults
#	Immutable
main_directory="$HOME/.playlister/"
config_file="${main_directory}playlister.conf"
helpfile="${main_directory}playlister.help"
playlist_ext=".plst"
mp3_ext=".mp3"
backup_ext=".bak"
#	Mutable
playlist_directory="${main_directory}playlists/"
mp3_directory="${main_directory}mp3s/"

function main () {
	if [[ "$#" -eq 0 ]]; then
		output-failure "invalid argument count (must be > 0)"
		exit 1
	fi
	while [[ "$#" -gt 0 ]]; do
		case $1 in 
			config)
				shift
				config "$@"
				exit 1
				;;
			*)
				output-failure "unrecognised option:\"$1\""
				shift
				exit 1
				;;
		esac
	done
}

function output-success () {
	local output="$1"
	local white="\e[1;37m"
	local green="\e[1;32m"
	>&2 echo -e "${white}(${green}+${white}) ${output}."
}

function output-failure () {
	local output="$1"
	local white="\e[1;37m"
	local red="\e[1;31m"
	>&2 echo -e "${white}(${red}-${white}) ${output}!"
}

function output-info () {
	local output="$1"
	local white="\e[1;37m"
	local yellow="\e[1;33m"
	>&2 echo -e "${white}(${yellow}*${white}) ${output}."
}

function config () {
	if [[ "$#" -eq 0 ]]; then
		output-failure "invalid config argument count (must be >0)"
		exit 1
	fi
	while [[ "$#" -gt 0 ]]; do
		case $1 in
			configure)
				config-configure
				exit 0
				;;
			list)
				config-list
				exit 1
				;;
			*)
				output-failure "unrecognised config option:\"$1\""
				exit 1
		esac
	done
}
function config-configure () {
	if ! create-directory "$main_directory" ; then
		exit 1
	fi
	
	if ! setup-file "$helpfile" "currentdir"; then
		exit 1
	fi
	
	if ! setup-file "$config_file" "backup" "makenew"; then
		exit 1
	else
		if read-config ; then
			output-success "$(basename "$config_file") read"
		else
			output-failure "$(basename "$config_file") failed to read"
			exit 1
		fi
	fi
	
	if ! create-directory "$mp3_directory"; then
		exit 1
	fi

	if ! create-directory "$playlist_directory"; then
		exit 1
	fi
}

function config-list () {
	local config_file_name="$(basename "$config_file")"
	
	if ! [[ -a "$config_file" ]]; then
		output-failure "$config_file_name does not exist"
		return 1
	fi

	if  ! read-config ; then
		output-failure "$config_file_name failed to read"
		return 1
	fi

	if ! list-config ; then
		output-failure "configurations failed to list"
		return 1
	fi
	return 0
}

function create-directory () {
	local directory="$1"
	local directoryname="$(basename "$1")"
	if [[ -d "$directory" ]]; then
		output-info "$directoryname exists"
	else
		mkdir $directory
		if [[ $? -ne 0 ]]; then
			output-failure "$directoryname failed to create"
			return 1
		else
			output-success "$directoryname created"
		fi
		
	fi
	return 0
}

function setup-file () {
	local filepath="$1"
	local filename="$( basename "$filepath" )"
	local backup="no"
	local currentdir="no"
	local makenew="no"
	shift
	while [[ "$#" -ne 0 ]]; do
		case $1 in 
			"backup")
				backup="yes"
				shift
				;;
			"currentdir")
				currentdir="yes"
				shift
				;;
			"makenew")
				makenew="yes"
				shift
				;;
			*)
				output-failure "unrecognised setup-file option:\"$1\""
				return 1
				;;
		esac
	done
	
	if [[ -a "$filepath" ]]; then
		output-info "$filename exists"
		return 0
	fi
	output-info "$filename does not exist"

	if [[ "$backup" == "yes" ]]; then
		local filepathbak="${filepath}${backup_ext}"
		if [[ -a "$filepathbak" ]]; then
			cp "$filepathbak" "$filepath"
			if [[ $? -eq 0 ]]; then
				output-success "$filename created from backup"
				return 0
			else
				output-failure "$filename failed to create from backup"
			fi
		else
			output-info "$filename has no backup"
		fi
	fi

	if [[ "$currentdir" == "yes" ]]; then
		if [[ -a  "$filename" ]]; then
			mv "$filename" "$filepath"
			if [[ $? -eq 0 ]]; then
				output-success "$filename fetched from current directory"
				return 0
			else
				output-failure "$filename failed to fetch from current directory"
			fi
		else
			output-info "$filename not found in current directory"
		fi
	fi

	if [[ "$makenew" == "yes" ]]; then
		touch "$filepath"
		if [[ $? -eq 0 ]]; then
			output-success "$filename created"
			return 0
		fi
		output-failure "$filename failed to create"
	fi
	
	output-failure "$filename setup failed"
	return 1
}

function read-config () {
	while read line ; do
		local argument="$(echo "$line" | cut -d "=" -f 1)"
		case "$argument" in
			"mp3_directory")
				local value="$(echo "$line" | cut -d "=" -f 2)"
				mp3_directory="$value"
				;;
			"playlist_directory")
				local value="$(echo "$line" | cut -d "=" -f 2)"
				playlist_directory="$value"
				;;
			*)
				output-failure "Not valid user config: \"$argument\""
				return 1
				;;
		esac
	done < "$config_file"
}

function list-config () {
    output-info "	Main directory	-> $main_directory "
    output-info "	Configurations	-> $config_file "
    output-info "	Help		-> $helpfile "
    output-info "	Playlists	-> $playlist_directory "
    output-info "	Music		-> $mp3_directory "
}

main "$@"

